<!DOCTYPE html>
<!--HTML5 doctype-->
<html>
	<!--   
   You may substitute jQuery for the App Framework selector library.
   See http://app-framework-software.intel.com/documentation.php#afui/afui_jquery
  -->
	<!-- content goes here-->

	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="app_framework/2.1/css/af.ui.min.kg.css">
		<link rel="stylesheet" type="text/css" href="app_framework/2.1/css/icons.min.css">
		<link rel="stylesheet" type="text/css" href="css/index_main.less.css" class="main-less">
		<link rel="stylesheet" type="text/css" href="css/GLBT.css">
		<title>GLBT Near Me</title>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
		<style type="text/css">
			/* Prevent copy paste for all elements except text fields */
			*  { -webkit-user-select:none; -webkit-tap-highlight-color:rgba(255, 255, 255, 0); }
			input, textarea  { -webkit-user-select:text; }
		</style>
		<script src="intelxdk.js"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript">
	var _map = null; // Google Map holder
	var currentLatitude = "";
	var currentLongitude = "";
	var options = {			// Intel GPS options
	    timeout: 10000,
	    maximumAge: 11000,
	    enableHighAccuracy: true
	};
	var markers = []; // markers array to clear
	var returnedList; // returned JSON list from GET
	var cat = "" ;		// category from form

	/* Intel native bridge is available */
	/**
	 *	Fires when DOM page loaded
	 */
	/**
	 *	Sets up GET parameters for the REQUEST from the form
	 *	@return GET string
	 */
	function getinitparams() {
		var zip = document.getElementById('distform').elements["zipcode"].value;
		var params = "" ;
	    if ( (zip == null || zip == "") &&
			 (currentLatitude == "") ) {
	        alert("You must enter a zip code or turn on navigation (GPS).");
		} else {
			var miles = document.getElementById('distform').elements["milesdist"].value;
			if ( zip != "" ) 
				params = "zip=" + zip;
			else
				params = "latitude=" + currentLatitude + "&longitude=" + currentLongitude;
			if ((miles.length > 0) && (miles > 0))
				params+= "&miles=" + miles;
		}
		return params;
	};
	/**
	 *	onclick function for "Map" button starts GET request
	 *	and redirects to bottom of page
	 */
	function mapformredirect() {
		var params = startlist();
		listpagefunc(params,cat,false);
		window.location.hash = "map_canvas";
	};
	/**
	 *	gets category from form and adds to GET request
	 *	@return GET string
	 */
	function startlist() {
		var params = getinitparams();
		cat = document.getElementById('distform').elements["category"].value;
		params += "&category=" + encodeURI(cat);
		return params;
	}
	/**
	 *	onclick function for "list" button
	 */
	function listformFn() {
		var params = startlist() ;
		listpagefunc(params,cat,true);
	};
	/**
	 *	onclick function for "National Organizations" button
	 */
	function nationalFn() {
		var params = "national=Yes";
		listpagefunc(params,"National",true);
	};
	/**
	 *	"Ajax" function that sends and processes xmlhttp request
	 *	@param params is GET request string
	 *	@param natnl is category for list
	 *	@makelist is whether list or map
	 */
	function listpagefunc(params,natnl,makelist) {
	    var xmlhttp;
		try {
		    xmlhttp=new XMLHttpRequest();
		} catch(e) {
			xmlhttp = false;
		}
		if (xmlhttp) {
		    xmlhttp.onreadystatechange=function()
		    {
		      if (xmlhttp.readyState==4 && xmlhttp.status==200)
			  {
//				alert(xmlhttp.responseText);
				returnedList = JSON.parse(xmlhttp.responseText);
				if (makelist)
					formatlist(params,natnl);
				else
					formatmap(params);
			  }
			}
			xmlhttp.open("GET","https://www.volunteerlogin.org/GLBTNearMe/AppResults.php" + '?' + params, true);
			xmlhttp.send(null);
		}
	}; // listpagefunc
	/**
	 *	formats map page, deletes old markers, checks to see if
	 *	you've entered a zip code, if you have, then ignore
	 *	GPS data and recenter map on zipcode lat / long
	 *	@param params is GET string
	 */
	function formatmap(params) {
	    var i;
	    var bounds = new google.maps.LatLngBounds();
		deleteMarkers(); // hopefully removes all markers
		var zip = document.getElementById('distform').elements["zipcode"].value;
		if (zip == "") { // no zip entered, use GPS if available
			var latlng = new google.maps.LatLng(currentLatitude, currentLongitude);
			var marker = new google.maps.Marker({
				position: latlng,
				map: _map,
				title: 'Current Position'
			});
			marker.setMap(_map);
			bounds.extend(latlng);
			endmapformat(bounds);
		} // we have geolocation
		else { // use zip code center instead
			var geocoder = new google.maps.Geocoder();
			geocoder.geocode( {'address': zip},function(results, status) {
			 	if (status == google.maps.GeocoderStatus.OK) {
		        //Got result, center the map and put it out there
					latlng = results[0].geometry.location;
					initialize(latlng);
			        var marker = new google.maps.Marker({
			            map: _map,
			            position: latlng,
						title: 'Current Position'
       				});
					bounds.extend(latlng);
					endmapformat(bounds);
				}// ends if
			});
		} // ends else
/*		var atext = "i is " + i ;
		alert(atext);
		document.getElementById("geostat").innerHTML=i;*/
	};
	/**
	 *	end of map format function 
	 *	needed because retrieving lat / long for zip code
	 *	is an asynchronous task, so need to call this function
	 *	at end of getting data function
	 *	@param bounds is bounds parameter for Google Map
	 */
	function endmapformat(bounds) {
		for(i = 0; i<returnedList.length; i++) 
			createMarker(i,bounds);
		if ( i > 0 ) // some markers added
		    _map.fitBounds(bounds);
	};
	/**
	 *	creates markers from returnedList, needed because
	 *	markers wouldn't show up if placed in same function
	 *	@param i is where in list we are in processing
	 *	@bounds is google map bounds to set
	 */
	function createMarker(i,bounds) {
		var latitude = returnedList[i].latitude;
		var longitude = returnedList[i].longitude;
		var latlng = new google.maps.LatLng(latitude, longitude);
		var pname = returnedList[i].Name;
		var c = "A";
		var iconchar = "images/purple_Marker" + String.fromCharCode(c.charCodeAt(0) + i%26) + ".png";
		var marker = new google.maps.Marker({
			position: latlng,
			map: _map,
			title: pname,
			icon: iconchar/*,
			zIndex: 1000*/
		});
		marker.setMap(_map);
		markers.push(marker); // array of all known markers
						// this is so we can call them all and
						// delete them when doing a new search
		bounds.extend(latlng);
	    var infoWindow = new google.maps.InfoWindow();
		pname = '<div style="color: black;">' +listhtml(i) + '</div>';
        google.maps.event.addListener(marker, 'click', function() {
            infoWindow.close();
	        infoWindow.setContent(pname);
/*	        infoWindow.setOptions({
	            content: pname
    		});*/
        	infoWindow.open(_map, marker);
        });
	}; // createMarker end

	/** Sets the map on all markers in the array.
	 *	@param map is google map variable
	 *	only used to delete all markers by setting "map" to null
	 */
	function setAllMap(map) {
	  for (var i = 0; i < markers.length; i++) {
	    markers[i].setMap(map);
	  }
	};

/** Removes the markers from the map, but keeps them in the array.*/
	function clearMarkers() {
	  setAllMap(null);
	};
/** Deletes all markers in the array by removing references 
 *	to them and setting markers[] array to empty.
 */
	function deleteMarkers() {
	  clearMarkers();
	  markers = [];
	};
	/**
	 *	formats listing after data returned from API
	 *	@param params is GET request string
	 *	@param natnl is category
	 */
	function formatlist(params, natnl) {
		var numberList = document.getElementById("natlisting");
	    var i;
		var oldcat = "" ;
		var namedist = "" ;
	    for(i = 0; i<returnedList.length; i++) {
			if ( oldcat != returnedList[i].Type ) {
				oldcat = returnedList[i].Type ;
				namedist+= '<p class="nlist">' + oldcat + '</p>';
			}
            //create new text node
			namedist += listhtml(i);
			namedist += "<br><br>";
	    }
		numberList.innerHTML=namedist;
		activate_subpage("#natsp"); // slides in list sub-page
	};
	/**
	 *	creates html entries for all list items
	 */
	function listhtml(i) {
		var namedist = returnedList[i].Name;
		var dist = returnedList[i].Distance;
		if (dist > 0)
			namedist += ' - ' + dist + ' Miles';
		var address1 = returnedList[i].Address1;
		if (address1.length > 0)
			namedist += "<br>" + address1;
		var address2 = returnedList[i].Address2;
		if (address2.length > 0)
			namedist += "<br>" + address2;
		var city = returnedList[i].City;
		var state = returnedList[i].State;
		var zip  = returnedList[i].Zip;
		if (city.length > 0)
			namedist += "<br>" + city + ', ' + state + ' ' + zip;
		var phone = returnedList[i].Phone;
		if (phone.length > 0)
			namedist += "<br>Phone: " + phone;
		var hotline = returnedList[i].Hotline;
		if (hotline.length > 0) {
			var c = hotline.substr(0,1);
			if (c >= '0' && c <= '9') {
				namedist += "<br>Hotline: " + hotline;
			}
		}
		var internet = returnedList[i].Internet;
		if (internet.length > 0)
			namedist += "<br>Email: " + internet;
		var web = returnedList[i].Web;
		if (web.length > 0)
			namedist += '<br>Web: <a href="' + web + '">' + web + '</a>';
		var moreinfo = returnedList[i].moreInformation;
		if (moreinfo.length > 0) {
			moreinfo = moreinfo.replace(/\n/g, "");
			moreinfo = moreinfo.replace(/["']/g, "");
			namedist += '<br><a href="#" onclick="alert(' + "'" +moreinfo + "'" + ')">More Information</a>' ;
		}
/*		var subcat = returnedList[i].sub-cat;
		if (subcat.length > 0)
			namedist += "<br>Sub-category: " + subcat; // can't use sub-cat */
		return namedist ;
	};
</script>
	<!--   
   You may substitute jQuery for the App Framework selector library.
   See http://app-framework-software.intel.com/documentation.php#afui/afui_jquery
  -->
		<script type="application/javascript" src="app_framework/2.1/appframework.js"></script>
		<script type="application/javascript" src="app_framework/2.1/appframework.ui.js" data-ver="1"></script>
		<script src="cordova.js"></script>
		<script src="xhr.js"></script>

		<script type="application/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript"
			 src="ui/min/jquery.ui.map.full.min.js">
		</script>
		<script type="application/javascript" src="js/index_user_scripts.js"></script>
		<script type="application/javascript" src="js/af_subpage.js"></script>
		<script type="text/javascript">
			/* Intel native bridge is available */
			af.feat.nativeTouchScroll = true; // sets up scrolling
			af.ui.ready(
			    function(){
			    //do something
//					alert("ui ready");
/*					if(typeof intel === 'undefined') {
					    ready();
					} else {
						onDeviceReady();
					}*/
				}
			);
		</script>
<style>
    #map_canvas {
        width:  100%;
        height: 380px;
    }
</style>
<script>
	/**
	 *	sets up google map to _map
	 *	@param latlng is latitude and longitude values in array
	 */
    function initialize(latlng) {
        var mapCanvas = document.getElementById('map_canvas');
	    var mapOptions = {
			center: latlng,
			zoomControl: true,
	        zoomControlOptions: {
	            style: google.maps.ZoomControlStyle.SMALL,
//	          position: google.maps.ControlPosition.LEFT_TOP
		    },
    	    zoom: 12,
    	    mapTypeId: google.maps.MapTypeId.ROADMAP
    	};
        _map = new google.maps.Map(mapCanvas, mapOptions);
//		setTimeout("$('#map_canvas').gmap('refresh')",500);
    };
</script>
	</head>


